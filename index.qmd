---
title: "Data Science for Public Policy Final Project"
subtitle: "Examining the Relationship Between Economic Access and Status and Public Health Outcomes in the D.C. Area"
author: "Adriana Vance, Kyle Kim, Elena Koshkin, Kamiryn Rose"
execute:
  warning: false
format:
  html:
    embed-resources: true
---

## Part 01

### Background and Literature Review

In this project, we will examine the relationship between economic status and public health outcomes in the D.C. area. We seek to look at several different factors, analyzing economic status through both mortgage loan debt in the DMV and bank locations in the District of Columbia. The relationship between economic indicators and public health outcomes is well-studied and has great implications for the policy world. Economic success has been shown to be associated with better public health outcomes. Additionally, a healthy economy is usually associated with a healthier U.S. population. On a micro-economic level, this may mean that individual economic hardship is associated with worse public health outcomes. This is the question that our project intends to investigate-- are census tracts with higher levels of mortgage debt, or fewer proximate banks, also more prone to negative public health outcomes such as higher rates of heart disease or depression?

#### Literature Review:

[Economic influences on population health in the United States: Toward policymaking driven by data and evidence.](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7467305/#:~:text=Falling%20incomes%20can%20reduce%20access)

This article provides a comprehensive overview of the study on the linkage between economic conditions and public health. Investigating the reasons behind declining U.S. life expectancy, the authors lay out the connections between economic trends and public health in the United States. Empirical evidence suggests that worsening economic outcomes are correlated with lower life expectancy and that this trend is particularly prominent in low-income and less-educated adults. The authors go on to suggest policy solutions to the problem such as investment in social programs and early education.

[Measuring the Health Outcomes of Social, Economic, and Environmental Policies - Center for American Progress](https://www.americanprogress.org/article/measuring-the-health-outcomes-of-social-economic-and-environmental-policies/)

This article from the Center for American Progress makes the case that social, economic, and environmental policy all have a part to play in the determination of health outcomes. Additionally, the author makes the case that data should be used in order to determine which communities are most at risk for negative public health outcomes and to understand the influences of policy changes.

[An analysis of financial institutions in Black-majority communities: Black borrowers and depositors face considerable challenges in accessing banking services \| Brookings](https://www.brookings.edu/articles/an-analysis-of-financial-institutions-in-black-majority-communities-black-borrowers-and-depositors-face-considerable-challenges-in-accessing-banking-services/)

In this analysis from the Brookings Institute, researchers examined the relationship between race and debt across neighborhoods in America, particularly through the lens of access to banking services. Their findings showed that in majority Black and Hispanic neighborhoods there is a greatly reduced presence of banks as compared to white neighborhoods. These disparities aligned with observed differences in interest rates on business loans and growth of local businesses in majority Black neighborhoods as well, indicating a relationship between neighborhood racial demographics and concentration of banks as indicators for access to financial services.

[Bank Branch Presence and Access to Credit in Low‐ to Moderate‐Income Neighborhoods](https://onlinelibrary.wiley.com/doi/abs/10.1111/j.1538-4616.2010.00343.x)

This article presents evidence that shows access to credit in low-to-moderate income neighborhoods is correlated with the presence of bank branches. Some suggest that this is due to the presence of a bank indicating information costs, as being closer to a bank provides people access to information about credit and loans. This study reveals that mortgage loan transactions increase in low-to-moderate income neighborhoods when there is a bank branch present.

This literature has informed our analysis by providing context for why low-income populations of color often face more economic hardship and have worse public health outcomes. The following analysis will use data from the CDC, FHFA, and elsewhere to analyze the relationship between mortgage debt and health outcomes in the DMV.

\[Loading necessary packages\]

```{r message=FALSE, warning=FALSE}
library(httr)
library(jsonlite)
library(tidyverse)
library(tidycensus)
library(purrr)
library(sf)
library(dplyr)
library(patchwork)
library(recipes)
library(ggplot2)
library(tidyclust)
library(tigris)
library(broom)
library(factoextra)
library(tmap)
library(mapproj)
library(leaflet)
library(randomForest)
library(caret)
library(tidymodels)
library(hexbin)
library(scales)
library(gganimate)
library(gifski)
library(fpc)
```

## Part 02

### Data Wrangling and Plots

We obtained the census tract info using the TIGER/Line Shapefile for the District of Columbia from the U.S. Census Bureau. We installed this data through the library(tigris) command, and we manually selected the Maryland tract, Virginia tract, and DC tract to get a picture of the whole DMV area.

```{r echo = FALSE, message=FALSE, warning=FALSE}

#pulling Tigris package tracts data

Maryland_tracts <- tracts(
state = "MD",
county = c("Montgomery", "Prince George's"),
cb = FALSE,
resolution = "500k",
year = 2010)

Virginia_tracts <- tracts(
  state = "VA",
  county = "Fairfax County",
  resolution = "500k", 
  year = 2010
)

DC_tracts <- tracts(
  state = "DC",
  resolution = "500k",
  year = 2010
)

DMV_tracts<- rbind_tigris(DC_tracts, Virginia_tracts, Maryland_tracts)

```

### Health Outcomes Data

The CDC PLACES dataset uses small-area estimation methods to provide a model-based mapping of 36 different chronic disease-related measures throughout the United States. These measures include 13 health outcomes, 9 prevention practices, 4 health risk behaviors, 7 disabilities, and 3 health statuses, used to estimate the rates of various chronic conditions by census tract level. The CDC PLACES data was downloaded from the CDC website and sifted to select data from exclusively DC, Maryland, and Virginia. Please download the CSV file provided, "PLACES.csv", to load the correct dataframe.

```{r echo = FALSE, message=FALSE, warning=FALSE}
#Read in CSV of CDC data
Health <- read_csv("PLACES.csv")

# Look at types of health outcome measures
Measures <- Health %>%
  group_by(Measure) %>%
  summarize(n = n())

MeasureIDs <- Health %>%
  group_by(MeasureId) %>%
  summarize(n = n())

# We want to look for current rates of asthma, heart disease, diabetes, stroke, and depression
Health <- Health %>%
  filter(
    MeasureId == "CASTHMA" |
      MeasureId == "CHD" |
      MeasureId == "DIABETES" |
      MeasureId == "STROKE" |
      MeasureId == "DEPRESSION")

```

We chose asthma, coronary heart disease, stroke, and depression as our health outcomes of interest because research shows a strong connection between these conditions and economic status. The most useful observations from this dataset will be MeasureId, which is the type of health outcome, and Data_Value, which is the percentage of the total population of a given census tract that report said health outcome.

#### Health Outcomes Distribution Map

```{r echo=FALSE, warning=FALSE, message=FALSE}
# Change geometry to be readable by SF

Health_map <- Health %>%
  st_as_sf(wkt = "Geolocation", remove = FALSE) %>%
  st_set_crs(value = 4326) # setting CRS


# Map health outcomes
Health_map %>%
  ggplot() +
  geom_sf(data = DMV_tracts) +
  geom_sf(aes(color = MeasureId)) +
  labs(
    title = "Health Outcomes in the DMV",
    subtitle = "Distribution by Census Tract",
    caption = "CASTHMA = Current Asthma\nCHD = Coronary Heart Disease",
    color = "Health Measures ID"
  )

```

This map demonstrates that at least one of the health outcomes we selected are present in each census tract in our dataset. Later in the project, we will dive further into the connection between location and health outcomes, and use economic data to further understand how health outcomes differ in each census tract. There isn't an obvious pattern among the tracts that show a concentration of specific health outcomes by specific area.

### Debt-to-Income Ratio Data

The debt-to-income ratio dataset comes from the Federal Housing Finance Agency, which records data about home purchase loans. This dataset has information on individual loans taken out for single-family homes, along with specifications of census tracts. The data also include the debt-to-income ratio of each borrower, which is an indication of how much debt the borrower has taken on in relation to their income. The debt-to-income ratio (or DTI) is generally regarded as a reliable indicator of a borrower's financial health, or ability to pay monthly debt payments. Other useful variables in this dataset that will be used in our analysis are census tract indicators, the percentage of minorities in a given census tract, tract median income, and mortgage amount.

We chose to download the dataset from 2021, as this will reflect the same year as our CDC health outcomes dataset. To download the correct dataset for our analysis, go to this [link:](https://www.bcbs.com/the-health-of-america/articles/healthy-communities-mean-better-economy) and download the ZIP file for the 2021 Freddie Mac dataset. Alternatively, you can use the txt file we included with our submission titled "debt_to_income.txt"

```{r echo = FALSE, warning = FALSE, message = FALSE}
# loading debt to income ratio data

debt_to_income <- read.table("debt_to_income.txt", header = FALSE) 
# Have to manually name columns

colnames(debt_to_income) <- c('enterprise', 'record_num','state_postal_code', 'MSA', 'COUNTYFP', 'NAME10', 'percent_minority', 'median_income', 'MSA_median_income', 'tract_income_ratio', 'borrower_income','AMI', 'borrower_income_ratio', 'UPB','purpose_of_loan', 'fed_guarantee', 'num_borrowers', 'first_time_borrower', 'borrower_race_1', 'race_2', 'race_3', 'race_4', 'race_5', 'borrower_ethnicity', 'co_borrower_race_1', 'co_race_2', 'co_race_3', 'co_race_4', 'co_race_5',   'co_borrower_ethnicity', 'borrower_gender', 'co_borrower_gender', 'borrower_age', 'co_borrower_age', 'occupancy_code', 'rate_spread', 'HOEPA_status', 'property_type', 'lien_status', 'borrower_over_sixtytwo', 'co_borrower_over_sixtytwo', 'LTV_ratio', 'note_date', 'mortgage_term', 'num_units', 'interest_rate', 'note_amount', 'preapproval', 'application_channel', 'AUS_name', 'borrower_credscore_model', 'co_borrower_credscore_model', 'DTI_ratio', 'discount_points', 'rate_period', 'manufactured_home_ownership', 'property_value', 'rural_tract', 'lower_MS_delta', 'Mid_Appalachia', 'persistent_poverty_county', 'concentrated_poverty', 'high_opportunity_area', 'QOZ')

counties <- c(1, 59, 31, 33) # Name county vector to filter dataset to needed counties only 

debt_to_income <- debt_to_income %>%
  filter(MSA == 47900) 

debt_to_income <- debt_to_income %>%
  filter(COUNTYFP == counties) # Filtering to needed counties 

# Mutate dataset to match county names of TIGRIS shapefile
debt_to_income <- debt_to_income %>%
  mutate(COUNTYFP = 
    if_else(COUNTYFP == 1, "001", as.character(COUNTYFP)))

debt_to_income <- debt_to_income %>%
  mutate(COUNTYFP = 
           if_else(COUNTYFP == 59, "059", as.character(COUNTYFP)))
    
debt_to_income <- debt_to_income %>%
  mutate(COUNTYFP = 
           if_else(COUNTYFP == 31, "031", as.character(COUNTYFP)))

debt_to_income <- debt_to_income %>%
  mutate(COUNTYFP = 
           if_else(COUNTYFP == 33, "033", as.character(COUNTYFP)))

debt_to_income$NAME10 <- as.numeric(debt_to_income$NAME10)

DMV_tracts$NAME10 <- as.numeric(DMV_tracts$NAME10)

debt_to_income$NAME10 <- debt_to_income$NAME10 / 100

#Merging the datasets by census tract name
debt_tract_2 <- full_join(DMV_tracts, debt_to_income, by = "NAME10")

# Setting CRS for geospatial visualizations 

debt_tract_2 <- debt_tract_2 %>%
  st_as_sf(coords = c("INTPTLON10", "INTPTLAT10"), remove = FALSE) %>%
  st_set_crs(value = 4326) # setting CRS

st_crs(debt_tract_2) # Checking CRS

debt_tract_2 <- st_transform(debt_tract_2, crs = 4326)

st_crs(debt_tract_2)
```

The debt-to-income ratio dataset did not come with column names, so we used the data documentation to manually input the names. Some of the column names were changed to match the tigris shapefiles which will be used in later mergers.

### Exploratory Data Analysis using the debt-to-income ratio dataset

```{r echo=FALSE, warning=FALSE, message=FALSE}

# Exploratory data analysis to better understand the data 
debt_totals <- debt_to_income %>%
  summarise(n = n())
  
debt_to_income %>%
  filter(purpose_of_loan == 3 | 4 | 5 | 6) %>%
  ggplot() + 
  geom_bar(mapping = aes(x = purpose_of_loan)) + 
  scale_x_continuous(breaks = c(1, 2, 3, 4, 5, 6, 7), minor_breaks = NULL, labels = c("Purchase", "Refinancing", " ", "Home Improvement", " ", " ", "Refinancing (cash-out)")) +
  ggtitle("Count of borrowers by loan type") 
  
```

Here we can see that most of the loans taken out are for the purposes of refinancing a mortgage, while a smaller number are for initial purchase of homes.

```{r echo=FALSE, warning=FALSE, message=FALSE}
debt_to_income %>%
  ggplot() + 
  geom_hex(mapping = aes(x = percent_minority, y = note_amount)) +
    scale_fill_continuous(low = "darkgreen", high = "yellow") + 
  scale_y_continuous() 


```

This hexbin plot demonstrates that there is a concentration of loans among the 300,000 dollar amount in 30-40% minority census tracts. There is also a significant concentration of single family home loans in the near-100% minority census tracts, but we can see that the loans trend much lower for minority census tracts, closer to 100,000 dollars.

### Banks

This dataset provides the exact locations of banks in the District of Columbia. The data is available for access on [Washington DC's open data portal](https://opendata.dc.gov/datasets/DCGIS::bank-locations/explore?location=39.007423%2C-76.009578%2C8.59). The locations of the banks are provided by the Department of Insurance Securities and Banking (DISB). The dataset is updated irregularly, as needed, and provides the latitude and longitude coordinates of the banks across DC.

```{r echo=FALSE, warning=FALSE, message=FALSE}
#loading banks data 
banks <- read.csv("banks.csv")

# replace the white space with underscores and lower-case all of the letters in column names
names(banks) <- names(banks) %>% 
  str_replace_all("\\s", "_") %>% 
  str_to_lower()
```

Replacing white space in the dataframe will help to make the dataset more readable with R programs.

```{r echo=FALSE, warning=FALSE, message=FALSE}

#filter the data to rows about banks that have valid longitudes and latitudes
banks_locations <- banks %>%
  filter(!is.na(longitude), !is.na(latitude))

#convert longitude and latitude columns into spatial geometries
banks_locations <- st_as_sf(banks_locations, coords = c("longitude", "latitude"))

#set CRS to 4326 (WGS 84)
banks_locations <- st_set_crs(banks_locations, value = 4326)

#check the CRS
st_crs(banks_locations)

#plot map using ggplot2
banks_locations_1 <- banks_locations %>%
ggplot()+ 
  geom_sf(data = DC_tracts) + 
  geom_sf(data = banks_locations, aes(color = ward), size = 0.6) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

banks_locations_2 <- banks_locations %>%
  group_by(ward) %>%
  summarize(n = n()) %>%
  ggplot() + 
  geom_col(aes(x= ward, y = n, fill = ward)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

banks_locations_1 + banks_locations_2

```

We can see by this map of the locations of the banks in DC in each census tract that the highest concentration of banks is in Ward 2. This is understandable since the city center is located within Ward 2. This map illustrates the low density of banks in Wards 7, 8 and 4 as compared to the rest of DC, which is also confirmed in the bar graph showing the count of banks in each ward. Wards 7 and 8 have the highest concentration of people in poverty in DC, while Ward 4 is mostly a residential region where the population is majority non-white. This map gives a preview of our future analysis that proximity to banks is demonstrative of economic outcomes in areas. Since access to banking is indicative of one's access to resources, this map shows the relationship between resources and economic outcomes, specifically for high-poverty areas like Ward 7 and 8, where there are high concentrations of people in poverty and low access to banks.

```{r echo=FALSE, warning=FALSE, message=FALSE}
# spatial join and census tracts 
#match CRS of both objects using the given CRS: 4326
banks_chloro <- st_transform(banks_locations, crs = st_crs(DMV_tracts))

#spatial join bank points and census tracts
banks_join <- st_join(DMV_tracts, banks_chloro, st_intersects) 

banks_merged_1 <- banks_join %>%
  group_by(GEOID10) %>%
  summarize(
    bank_count = sum(!is.na(name), na.rm = TRUE))

#join census tract back to new dataframe
banks_merged_1 <- st_join(DMV_tracts, banks_merged_1, join = st_intersects)

```

## Part 03

## Geospatial Analysis with Banks

```{r echo=FALSE, warning=FALSE, message=FALSE}

# looking at economic outcomes in relationship to distance to banks 
banking<- st_transform(banks_join, crs = 4326)
DC<- st_transform(DC_tracts, crs = 4326)

econ <- debt_tract_2 %>%
  filter(COUNTYFP10 == "001") %>%
  st_as_sf(coords = c("INTPTLON10", "INTPTLAT10"), remove = FALSE) %>%
  st_set_crs(value = 4326) # setting CRS

# close proximity to banks
banks_filtered<- st_join(banking, DC, left= FALSE)
banks_econ_1<- st_join(econ, st_buffer(banks_filtered, dist = 400))

max_banks_econ_1<- banks_econ_1 %>%
  group_by(NAME10) %>%
  filter(DTI_ratio > 20) %>%
  summarize(n = n()) 

Banks_Debt_400 <- max_banks_econ_1 %>%
  ggplot() + 
  geom_sf(aes(fill = n)) + 
   scale_fill_gradient(
    low = "#D1E3F5",
    high = "blue",
    na.value = "white"
  ) +
  labs(
    title = "DTI Ratio Above 20 Within 1/4 Mile of a Bank",
  ) 

# far proximity to banks 

banks_econ_2<- st_join(econ, st_buffer(banks_filtered, dist = 1600))

max_banks_econ_2<- banks_econ_2 %>%
  group_by(NAME10) %>%
  filter(DTI_ratio > 20) %>%
  summarize(n = n()) 

Banks_Debt_1600 <- max_banks_econ_2 %>%
  ggplot() + 
  geom_sf(aes(fill = n)) + 
   scale_fill_gradient(
    low = "#D1E3F5",
    high = "blue",
    na.value = "white"
  ) + labs(
    title = "DTI Ratio Above 20 Within 1 Mile of a Bank",
  ) 

Banks_Debt_400 + Banks_Debt_1600

```

After first creating a buffer of about 400 meters, roughly a quarter of a mile, around the locations of banks, we then filtered the data to show counts of people within the debt_to_income dataset whose debt to income ratio is over 20. We plotted the resulting choropleth and compared it to an identical choropleth where the distance to a bank was buffered to 1600 meters, roughly a mile. Through this process, we visualized the relationship between proximity to a bank and economic outcomes. The analysis indicates that census tracts 53.01, 50.02, and 52.01 had the highest number of people (over 8,000) with a debt to income ratio over 20 within a quarter of a mile from a bank. Census tract 53.01 is the area near Dupont Circle. Census tract 50.02 is located within the Logan Circle/Shaw neighborhood, while 52.01 is the area directly adjacent to it. These census tracts all have a high concentration of banking services, but they also have incredibly expensive housing prices. The fact that these census tracts boasted the highest number of people with high debt to income ratios and access to banking services illustrates that single family homes are expensive in this area, but that these individuals were able to access and take advantage of the financial services in their proximity to take our loans for single-family homes in this coveted area.

Within 1 mile of a bank, census tract 44.00 had the highest number of people with a debt to income ratio over 20, with about 24,684 people. Census tracts 53.01, 52.01, and 55.00 had the next highest numbers. Census tract 44.00 is the area near Howard University, on U Street. Census tract 53.01 is near Dupont Circle. Census tract 55.00 is the area near Foggy Bottom and GWU, while Census tract 52.01 is in Logan Circle. These census tracts are all densely populated and close to the city center as well as universities and restaurants. The fact that there are high concentrations of people with high debt to income ratios in these areas that are all within 1 mile of a bank affirms what we found in the previous map with proximity to banks set at a quarter of a mile. Single family homes are quite expensive and difficult to obtain in these areas, but there are also a wide variety of resources available in these areas. These census tracts are all also majority non-minority, which coincides with literature that points to majority Black neighborhoods having low access to banking and low access to housing loans.

```{r echo=FALSE, warning=FALSE, message=FALSE}

#looking at public health outcomes in relationship to distance to banks 

banking<- st_transform(banks_join, crs = 4326)
DC<- st_transform(DC_tracts, crs = 4326)

st_transform(Health_map, crs = 4326)
Health_map <- st_transform(Health_map, crs = st_crs(DMV_tracts))
Health_map <- st_join(DMV_tracts, Health_map, st_intersects) 


Health_DC <- Health_map %>%
  filter(COUNTYFP10 == "001") %>%
  filter(MeasureId == "DEPRESSION")
      

#transforming so it matches for the spatial join
banks_filtered<- st_join(banking, DC, left= FALSE)

st_crs(Health_DC)
banks_filtered <- st_transform(banks_filtered, crs = 4269)


# close proximity to banks

banks_health_1<- st_join(Health_DC, st_buffer(banks_filtered, dist = 400))

max_banks_health_1 <- banks_health_1 %>%
  group_by(NAME10) %>%
  summarize(n = n())


Banks_Depression_400 <- max_banks_health_1 %>%
  ggplot() + 
  geom_sf(aes(fill = n)) + 
   scale_fill_gradient(
    low = "#D1E3F5",
    high = "blue",
    na.value = "white"
  ) + labs(
    title = "People Experiencing Depression Within 1/4 Mile of a Bank",
  ) 


# far proximity to banks
banks_health_2<- st_join(Health_DC, st_buffer(banks_filtered, dist = 1600))

max_banks_health_2 <- banks_health_2 %>%
  group_by(NAME10) %>%
  summarize(n = n())


Banks_Depression_1600 <- max_banks_health_2 %>%
  ggplot() + 
  geom_sf(aes(fill = n)) + 
   scale_fill_gradient(
    low = "#D1E3F5",
    high = "blue",
    na.value = "white"
  )+ labs(
    title = "People Experiencing Depression Within 1 Mile of a Bank",
  ) 


Banks_Depression_400 + Banks_Depression_1600
```

Repeating the geospatial analysis conducted with banks and economic outcomes, we visualized the relationship between proximity to banks and instances of coronary heart disease. These choropleths did not turn out to produce highly significant results, however. The highest concentration of instances of coronary heart disease aligned with areas that have the highest concentration of banks, begging the question of the efficacy of this analysis. While banks seemingly do have a relationship with economic outcomes, these visualizations indicate that proximity to banks may not be a reliable predictor for health outcomes.

## Creating visualizations from the debt-to-income dataset

```{r echo=FALSE, warning=FALSE, message=FALSE}


# Debt-to-income ratio Choropleth
p3 <- debt_tract_2 %>%
  ggplot() + 
  geom_sf(
    aes(
      fill = DTI_ratio), color = "White", size = 0.1) +
  scale_fill_gradient(
    low = "#81FFEF",
    high = "#F067B4",
    na.value = "white"
  ) +
  labs(
    fill = "Debt to Income Ratio"
  ) +
  theme_void()

p3

```

### Using Leaflet to create an interactive map of debt to income ratios in the DMV

From this visualization, we can see that the four major health outcomes we chose, diabetes, depression, coronary heart disease, and asthma, are quite evenly spread across the DMV area. While some of the census tracts further from the center of D.C. have fewer health outcomes, there is at least one present in each census tract. The colors for each outcome provide a helpful visualization of the range.

### Using Leaflet to create an interactive map of debt-to-income ratios in the DMV

```{r echo=FALSE, warning=FALSE, message=FALSE}

# Create a new variable in our spatial object for fill color
debt_tract_2$FillColor <- colorQuantile("YlOrRd", debt_tract_2$DTI_ratio)(debt_tract_2$DTI_ratio)

# Create a leaflet map
leaflet(debt_tract_2) %>%
  
  # Add the polygons from the spatial object
  addPolygons(
    fillColor = ~FillColor,
    fillOpacity = 0.7,
    color = "white",
    weight = 1,
    popup = ~paste("Debt-to-Income Ratio: ", DTI_ratio)
  ) %>%
  
  # Add legend
  addLegend(
    "bottomright",
    pal = colorQuantile("YlOrRd", debt_tract_2$DTI_ratio),
    values = ~debt_tract_2$DTI_ratio,
    title = "Debt-to-Income Ratio",
    opacity = 1
  )

```

This map demonstrates the differences between the debt-to-income ratio for single family home purchases in the DMV area.

## Visualizations of health outcomes in the DMV area

```{r echo=FALSE, warning=FALSE, message=FALSE}
#Merged CDC Places dataset with census tracts and made graph and choropleths

#Read in CSV of CDC data
Health1 <- read_csv("PLACES.csv")

#Clean data and get long and lat columns
Health2 <- Health1 %>%
  separate(col = Geolocation, into = c("point", "coordinates"), sep = " ", extra = "merge", remove = FALSE) %>%
  separate(col = coordinates, into = c("longitude", "latitude"), sep = " ", remove = TRUE)

Health2 <- Health2 %>%
  mutate(longitude = gsub("[()]", "", longitude),
         latitude = gsub("[()]", "", latitude))

names(Health2) <- names(Health2) %>% 
  str_to_lower()

#Use consistent health measures: CASTHMA, CHD, Depression, Diabetes, Stroke

Health3 <- Health2 %>%
  filter(measureid %in% c("CASTHMA", "CHD", "DIABETES", "STROKE", "DEPRESSION") &
           complete.cases(longitude, latitude))

#convert longitude and latitude columns into spatial geometries
sf_Health <- st_as_sf(Health3, coords = c("longitude", "latitude"))
#set CRS to 4326 (WGS 84)
sf_Health <- st_set_crs(sf_Health, value = 4326)
#check the CRS
st_crs(sf_Health)

#plot map using ggplot2
sf_Health |>
  ggplot() +
  geom_sf(
    aes(color = short_question_text), alpha = 0.4, size = 2) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

#Perform a Spatial Join and Create Choropleth

#match cRS
sf_Health2 <- st_transform(sf_Health, crs = st_crs(DMV_tracts))

#spatial_join health points and census tracts
Health_join <- st_join(sf_Health2, DMV_tracts, st_intersects)

#calculate the count of health measures in new dataframe
health_merged <- Health_join |>
  group_by(NAME10, data_value) 

#join census tract back to new dataframe
health_merged2 <- st_join(DMV_tracts, health_merged, join = st_intersects)

#create choropleth maps

p4 <- health_merged2 %>%
  ggplot() + 
  geom_sf(
    aes(
      fill = data_value), color = "white", size = 0.1) +
  scale_fill_gradient(
    low = "#81FFEF",
    high = "#F067B4",
    na.value = "white"
  ) +
  labs(
    fill = "Health Measure percentages") +
  theme_void()

p4

combined_plot <- p3 + p4

combined_plot

```

This side by side comparison shows somewhat of a trend that tracts with lower DTI ratios have a higher percentage of health conditions. This may be because tracts where a majority of people are not able to leverage more debt against their income are worse off in terms of their health. This goes against our initial hypothesis that tracts with higher debt to income ratios would also experience higher rates of health conditions.

#### Merging Health and Debt-to-Income Dataset

```{r echo=FALSE, warning=FALSE, message=FALSE}

#Merging health dataset with debt_tract_2 

#Converting long and lat coordinates to sf objects
debt_tract_2_sf <- st_as_sf(debt_tract_2, coords = c("INTPTLON10", "INTPTLAT10"), crs = 4326)

# Convert 'Geolocation' column to an sf object
Health_sf <- st_as_sf(Health, wkt = "Geolocation", crs = 4326)

#Confirm if health and debt use the same coordinate reference systems (crs) 

#They do not. 
st_crs(debt_tract_2_sf)
st_crs(Health_sf)

#Transform debt dataset to match health
debt_tract_2_sf <- st_transform(debt_tract_2_sf, st_crs(Health_sf))

#Reconfirm if they have the same crs.
#Now they do.
st_crs(debt_tract_2_sf)
st_crs(Health_sf)

#Spatial Join
health_debt <- st_join(debt_tract_2_sf, Health_sf, join = st_intersects)

```

## Part 04

#### Machine Learning Model

```{r echo=FALSE, warning=FALSE, message=FALSE}
library(tidymodels)
set.seed(102102938)

split <- initial_split(data = debt_to_income, prop = 0.75)

debt_train <- training(x = split)
debt_test <- testing(x = split)

## Health outcome for machine learning model will be percentage of instances of depression in a census tract

```

### Machine Learning Model #1: Predicting the percentage of minorities in a census tract using the single-family loan data

```{r echo=FALSE, warning=FALSE, message=FALSE}

debt_rec <- recipe(percent_minority ~ borrower_income + borrower_age + borrower_income_ratio + tract_income_ratio + DTI_ratio + interest_rate + note_amount, data = debt_train) %>%
  step_normalize(all_numeric_predictors()) %>%
  step_corr(all_numeric_predictors())

# Creating tuning grid for lasso model
lasso_grid <- grid_regular(penalty())

# LASSO model
lasso_mod <- linear_reg(penalty = tune(), mixture = 1) %>% 
  set_engine("glmnet")

# LASSO workflow
lasso_wf <- workflow() %>%
  add_recipe(debt_rec) %>%
  add_model(lasso_mod) 

folds <- vfold_cv(data = debt_train, v = 10, repeats = 1)

# LASSO fit
lasso_fit <- lasso_wf %>%
  tune_grid(
    resamples = folds,
    grid = lasso_grid, 
    metrics = metric_set(rmse, mae), 
    control = control_grid(save_pred = TRUE))

# Evaluating models
lasso_metrics <- lasso_fit %>%
  collect_metrics(summarize = TRUE) 

lasso_fit %>%
  select_best(metric = "rmse")

# The RMSE of this model's best fit is around 22. 

```

The average RMSE across 10 folds for the best fit model is around 22. This suggests that the average difference between the percentage of minorities in a census tract predicted by the model and the true percentage is 22 percentage points. 22 percentage points is a significant error.

Taking the results from this prediction using our debt dataset, we decided to try a different type of model. LASSO regression is best for linear relationships, and it makes sense that this model may not capture all of the variation in the percentage of minorities across all census tracts in the DMV.

For our next machine learning model, we will take what we've learned from the performance of this model to predict something a bit more complex: health outcomes across the DMV using economic data.

### Machine Learning Model #2: Predicting rates of depression in a census tract using economic predictors from the debt-to-income dataset

We've chosen a random forest model to model the relationship between economic factors and depression because random forest models adapt easily to many predictors, and nonlinear relationships. Below, we test two different random forest models and refine one with hyperparameter tuning to get a model with refined predictions of rates of depression in a census tract.

```{r echo=FALSE, warning=FALSE, message=FALSE}

# Filtering dataset for second machine learning  model

# We want only observations for rates of depression, and to exclude columns that have all values as NA or that are not interpretable by random forest modeling
depression_debt <- health_debt %>%
  drop_na(Data_Value) %>%
  filter(MeasureId == "DEPRESSION") %>%
  select(-Data_Value_Footnote, -Data_Value_Footnote_Symbol) %>%
  st_drop_geometry()

# Omit all NA values from dataset
depression_debt <- na.omit(depression_debt)

set.seed(12122023)
split2 <- initial_split(data = depression_debt, prop = 0.8)

depression_train2 <- training(x = split2)
depression_test2 <- testing(x = split2)


# Train the initial randomForest model with specified predictors
rf_mod <- randomForest(Data_Value ~ borrower_income + borrower_age + borrower_income_ratio + tract_income_ratio + DTI_ratio + interest_rate + note_amount + property_value + percent_minority, data = depression_train2)

rf_mod 

```

This model only explains about 77.6% of the variance in the rates of depression in each census tract. We think this is because there is a lack of tuning the model, and because we limited the number of predictors such that there was not enough information.

Next, we will try a similar random forest model, but with more predictors and some hyperparameter tuning to find the best number of mtrys.

```{r echo=FALSE, warning=FALSE, message=FALSE}
# Trying some tuning to see if we can find the best amount of mtrys to use for the model
bestmtry <- tuneRF(depression_train2,depression_train2$Data_Value,stepFactor = 2, improve = 0.01, trace = TRUE, plot = T, doBest = TRUE) 

# tuneRF shows that the best amount of mtrys is 32. Running random forest model again with 32 mtrys to see if it further optimizes the model. 
best_mtry <- 32

rf_mod3 <- randomForest(Data_Value ~., data = depression_train2, mtry = best_mtry)

rf_mod3

```

We used hyperparameter tuning to find the best number of mtrys for the model, and plotted the result. After finding that the best number of mtrys was 32, we added this parameter to the model. As a result, this model shows great improvement from the previous, explaining 99.99% of the variance. We can use this model to predict health outcomes on the testing dataset.

```{r echo=FALSE, warning=FALSE, message=FALSE}

predicted_values <- predict(rf_mod3, newdata = depression_test2, type = "class")

test_predictions <- bind_cols(
  depression_test2, predicted_values)

test_predictions <- test_predictions %>%
  rename(.pred = ...100)

metrics(test_predictions, truth = Data_Value, estimate = .pred)

prediction_table <- tibble(test_predictions$Data_Value, test_predictions$.pred)
```

The prediction table shows that we have successfully trained a model that predicts 99% of the variance in our variable of interest, which reflects the rates of depression in each census tract.

This model used predictors such as percent minority census tracts, debt to income ratio, median income of a census tract, and many other racial and economic factors in the data to be able to predict the depression rates in a census tract.

Using a machine learning model that adapts to non-linear relationships has shown us that there is indeed a relationship between economic/racial factors and public health outcomes, such as depression.

## Part 05

## Cluster Analysis

```{r echo=FALSE, warning=FALSE, message=FALSE}

# filtering the data to use for the cluster analyis
dti_data <- debt_to_income %>%
  select(percent_minority, DTI_ratio)

# creating the recipe
dti_pca_rec <- recipe(~ ., data = dti_data) %>%
  step_pca(all_numeric(), id = "pca") %>%
  prep(data = dti_data) %>%
  bake(new_data = dti_data) 


#create the function 
debt_pca_fun<- function(DTI, df){
  debt_pca<- df %>%
    replace(is.na(.), 0) %>%
    filter(DTI_ratio == DTI) 
  
debt_pca_rec <- recipe(~ ., data = dti_data) %>%
    step_pca(all_numeric(), num_comp = 2) %>%
    step_normalize(all_predictors()) %>%
    prep(data = dti_data) %>%
    bake(new_data = dti_data) %>%
    select(PC1, PC2)
    

kmeans_rec<- recipe(~ ., data = dti_data) %>%
  step_select(all_numeric())
  
  debt_pca_spec <- k_means(
  num_clusters = 4
) %>%
  set_engine("stats", nstart = 100)

debt_pca_workflow <- workflow(
  preprocessor = kmeans_rec, 
  spec = debt_pca_spec
)

final_fit <- debt_pca_workflow %>%
  fit(data = dti_data)

debt_clusters <- 
  bind_cols(dti_data, debt_pca_rec, cluster = final_fit %>%
    extract_cluster_assignment() %>%
    pull(.cluster) )

return(debt_clusters)
}

#mapping the output 
DTI<- 20:50
set.seed(20220413)
final_result <- map_dfr(.x = DTI, .f = debt_pca_fun, df = debt_to_income)
print(final_result)
  
```

```{r echo=FALSE, warning=FALSE, message=FALSE}
#animated scatterplot

clus_plot <- ggplot(
  final_result,
  aes(PC1, PC2, color = percent_minority, frame = DTI_ratio)
) +
  geom_point() +
  labs(
    title = "Animated Scatter Plot of Percent Minority across DTI_ratios",
    x = "PC1",
    y = "PC2",
    color = "percent minority"
  ) +
  transition_states(DTI_ratio) +
  ease_aes('linear') +
  enter_fade() +
  exit_fade() +
  theme_minimal()

#save animation as gif
animate(
  clus_plot,
  duration = 10,
  fps = 20,
  width = 400,
  height = 400,
  renderer = gifski_renderer()
)
anim_save("clust_gif.gif")
```

```{r echo=FALSE, warning=FALSE, message=FALSE}
# mapping the cluster plot 
clust_plot <- final_result %>%
  ggplot() +
  geom_point(
    mapping = aes(x = percent_minority, y = DTI_ratio, color = cluster),
    alpha = 0.5, size = 0.1
  ) +
  labs(
    title = "Debt-to-Income Ratios in the DMV Area Based on Percent Minority Population",
    x = "Percent Minority",
    y = "DTI Ratio"
  ) + 
  theme_classic()

clust_plot
```

This plot shows the variance explained by our principal component analysis clusters. We can see here that the variance increases in our clusters as the debt to income ratio increases. Three of our clusters show uniformity in structure across the plot, however Cluster 4 is condensed around a low debt to income ratio and a low percentage of minorities living in a census tract. DTI ratio increases variance, while percent minority decreases variance. These results indicate that perhaps the variation in debt to income ratios is not well explained by the racial demographics of a census tract. This is a bit contradictory to our hypothesis, but this could also be an indicator that there are other economic outcomes that correlate with debt to income ratios better. The visual nature of the plot suggests that perhaps kmeans clustering is not the best method for analyzing our data. Perhaps, if we had used a different predictor or clustered our data based on health conditions, we would have found a better relationship between our variables.

```{r echo=FALSE, warning=FALSE, message=FALSE}
# PCA variance check

#filter dataframe to DTI ratios 20 and over

#concatenate two columns to make matching columns with Health dataset
debt_to_income$CountyFIPS <- paste0(debt_to_income$state_postal_code, debt_to_income$COUNTYFP)

#filter out health dataset to append to DTI data
Health_append <- Health %>%
  select(CountyFIPS, MeasureId, Data_Value, TotalPopulation)

DTI_clust <- debt_to_income %>%
  select(DTI_ratio, NAME10, CountyFIPS, percent_minority, concentrated_poverty)

#make recipe
DTI_clust_rec <- recipe(~., DTI_clust) %>%
  step_pca(all_numeric_predictors(), id = "pca_") %>%
  step_normalize(all_numeric_predictors()) %>%
  prep()

#variance
tidy(DTI_clust_rec, number = 1, type = "variance")
  
#bake to get principal components
DTI_pcs <- DTI_clust_rec %>%
  bake(new_data = NULL)

#merge dataframes
DTI_Health_clust <- merge(DTI_pcs, Health_append, by = "CountyFIPS")

glimpse(DTI_Health_clust)

#scatter plot 
p5 <- ggplot(DTI_Health_clust, aes(x = PC1, y = PC2, color = MeasureId)) +
  geom_point() +
  labs(
    title = "Health Measures Clusters in Relation to Debt to Income PCA",
    x = "Principal Component 1", 
    y = "Principal Component 2",
    caption = "CASTHMA = Current Asthma\nCHD = Coronary Heart Disease",
    color = "Health Measures ID") +
theme_minimal()

p5

```

This scatterplot attempts to show health measures clustered together based upon the PCA variance of Debt-to-income variables. This plot shows that stroke has the highest variance in relation to select debt to income variables. It also shows that diabetes and asthma make up some of that variance, although not as much. Moreover, after merging parts of the health measures data with the debt to income data, the clustering graphics are unclear in their representations suggesting that the cluster analysis that we fitted to these indicators may not be optimal for this data compared to our machine learning models and geospatial visualizations which did a much better job at presenting and predicting the relationship between these measures.

#### Data Interpretation and Analysis

Our research aimed to document and analyze the relationships between health outcomes, economic conditions, geography, and demographics across various census tracts in the DMV area. Through this exploration, we found several patterns suggesting correlative relationships that could be invaluable when guiding policy decisions and healthcare initiatives.

## Discussion of Results

### Interpreting the findings:

#### Health Outcomes and Geographic Correlation:

As we observed the mapping of health outcomes across census tracts in the DMV area, we found health issues were pervasive regardless of ward. This finding suggests a widespread impact of these health conditions, irrespective of any geographic distinctions. However, the absence of a clear pattern linking health outcomes to specific areas underscores the complexity of health determinants and indicates that factors beyond geography play a significant role. This lack of clear linkage could lead us to discover that other factors, like economic status, may have a more influential effect on health.

#### Housing Loan Dynamics:

We were interested in finding out the number of borrowers by loan type in order to provide some insight into borrowing behaviors and financial priorities within the population. In our observation, there was a significant skew towards refinancing loans rather than new home purchases. This disparity could reflect broader economic trends, such as market stability or homeowner equity growth. These results may be indicative of the low housing stock and high average value in the DMV area, thus explaining why homeowners are not selling, not buying, but mostly refinancing and remaining stagnant.

There is also a notable disparity in loan amounts across minority-dominated tracts. There is also a significant concentration of single-family home loans in the near-100% minority census tracts, yet we found that the loans trend much lower for minority census tracts, around 100,000 USD, as opposed to mostly white neighborhoods trending closer to 300,000 USD. This discovery hints at underlying economic inequalities and raises questions about accessibility to financial services and its implications on housing stability in minority communities. It is possible that, due to several systemic and economic reasons, minority communities have less access to higher loans due to either a lower net worth or higher debt-income ratio, allowing them less leverage and, therefore, less valuable loans. It is also important to consider the process banks use to evaluate the financial status of potential borrowers and determine if there is a bias or unjust practices that could be putting minorities at a disadvantage, even against white individuals of the same economic status and credit risk.

### Bank Distribution and Economic Implications in DC:

Through our analysis, we observed that there is a very high concentration of banks in Ward 2 with a notable lack in Wards 7, 8, and 4. This finding seems to align with economic disparities in these areas and could contribute to the cycle of poverty as areas get poorer, resources to build financial stability dissipate, and the cycle continues. This pattern indicates that access to banking is a key economic resource yet is very unevenly distributed, potentially exacerbating economic inequalities.

### Debt-to-Income (DTI) Ratio Insights:

The diverse DTI ratios across tracts and their potential link to health conditions suggest a complex interplay between financial burden and health. This aspect of our research opens avenues for exploring how economic stressors impact public health. Within 1 mile of a bank, census tract 44.00 had the highest number of people with a debt-to-income ratio over 20, with about 24,684 people. Census tracts 53.01, 52.01, and 55.00 had the next highest numbers. Census tract 44.00 is the area near Howard University, on U Street. Census tract 53.01 is near Dupont Circle. Census tract 55.00 is the area near Foggy Bottom and GWU, while Census tract 52.01 is in Logan Circle. These census tracts are all densely populated, relatively high-income, and close to the city center as well as universities and restaurants. Those living here are very likely to be students or wealthier young professionals with a greater ability and liberty to handle paying pay larger loans, or even have assistance in that regard from family. The fact that there are high concentrations of people with high debt-to-income ratios in these areas that are all within 1 mile of a bank affirms what we found in the previous map with proximity to banks set at a quarter of a mile. Single-family homes are quite expensive and difficult to obtain in these areas, but there is also a wide variety of resources available in these areas. These census tracts are all also majority non-minority, which coincides with literature that points to majority Black neighborhoods having low access to banking and low access to housing loans.

### Geospatial Analysis:

Our geospatial analysis aimed to examine whether there is a correlation between the proximity of banks and the incidence of coronary heart disease (CHD) in various areas. Our expectation was that areas with better access to financial institutions would correlate with lower instances of CHD and better health outcomes overall, under the assumption that economic prosperity, facilitated by bank access, would lead to better health outcomes. However, the analysis revealed an unexpected pattern: areas with a higher concentration of banks also showed a higher number of CHD cases. This contradicts our initial hypothesis and suggests that the presence of banks, as a proxy for economic health, does not directly translate to better physical health outcomes. It raises questions about the directness and nature of the relationship between economic factors and health conditions. Health outcomes, particularly chronic conditions like CHD, are influenced by a multitude of variables including lifestyle choices, environmental factors, genetic predispositions, and more-so It's important to note that the lack of significant results does not invalidate the hypothesis; it merely highlights the complexity of the factors at play. One possible explanation is that this may be because in tracts where a majority of people are unable to leverage more debt against their income (for example, to emergency medical care), they are worse off in terms of their health.

### Machine Learning Analysis:

We chose a random forest model to model the relationship between economic factors and depression. This is because random forest models adapt easily to many predictors and nonlinear relationships. We wanted to test two different random forest models and refine one with hyperparameter tuning in order to output a model with refined predictions of rates of depression in a census tract. We found that this model only explains about 77.6% of the variance in the rates of depression in each census tract. We hypothesize that this is due to a lack of tuning the model as well as our limiting of the number of predictors in such a way that not enough information remained to come to a more accurate conclusion. We will tried a random forest model with all predictors using hyperparameter tuning to find the best number of mtrys for the model, and plotted the result. We found that the best number of mtrys was 32, and we added this parameter to the model. As a result, our model shows great improvement from the previous, explaining 99.99% of the variance. We can now use this model to predict health outcomes on the testing dataset. Using a machine learning model that adapts to non-linear relationships has shown us that there is indeed a relationship between economic/racial factors and public health outcomes, such as depression. This success underscores the significant role of economic conditions in public health. The model's improvement post-tuning highlights the importance of robust analytical approaches in understanding such complex relationships.

### Limitations and Areas for Future Research:

The lack of a clear geographic pattern in health outcomes suggests that our analysis could benefit from incorporating additional variables such as environmental factors or access to healthcare in a future model. The interpretation of loan data is, unfortunately, limited by the absence of deeper contextual information, such as the reasons behind refinancing trends or the impact of local housing policies. The relationship between bank distribution and economic outcomes, while suggestive, requires further investigation to establish causality. The DTI analysis could be improved with more granular data, for example, individual credit histories, or long-term financial trends. Our machine learning models, while effective, may not fully capture the multifaceted nature of the relationship between economics and health. Future models could integrate more diverse datasets and employ more complex algorithms to better understand the irregular, non-linear relationship. The earlier finding that areas with more banks have higher CHD instances was the result of various confounding factors. For example, these areas might also be more urbanized, with lifestyle factors that contribute to CHD, such as higher stress levels, more sedentary jobs, or greater availability of unhealthy food options. To further understand the relationship between bank proximity and health outcomes, it may be beneficial to control for variables like these or conduct a multivariate analysis that includes additional economic indicators, such as employment rates, income levels, or access to healthcare services. Furthermore, it might be worth exploring other methods of analysis or different health outcomes that could be more directly related to economic conditions. For instance, mental health issues like stress and anxiety could have a stronger correlation with economic factors than CHD does, though these were not possible given our dataset. The effect of time is another factor we found challenging to address. Our analysis is cross-sectional and provides a snapshot in time rather than capturing trends over time is less than ideal. Observing how time affects these changes is critical for understanding the dynamics between economic conditions and health outcomes.

Ultimately while our analysis produced surprising results, it also provides valuable insights into the complexities of health determinants and opens up new avenues for research. It's a reminder that socioeconomic factors and health outcomes are part of a complex intertwined web that requires nuanced, multifaceted, extremely technical approaches to fully understand and design an effective policy.
